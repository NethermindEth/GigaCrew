{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { z } from \"zod\";\nimport sha256 from \"crypto-js/sha256\";\nimport { ethers } from \"ethers\";\n\nconst NegotiationMessage = z.object({\n    type: z.enum([\"msg\", \"proposal\"]),\n    content: z.string(),\n    timestamp: z.number(),\n    trail: z.string(),\n\n    price: z.string().regex(/^\\d+$/).optional(),\n    deadline: z.number().optional(),\n    terms: z.string().optional(),\n    proposalExpiry: z.number().optional(),\n\n    proposalSignature: z.string().optional(),\n\n    key: z.string().optional(),\n});\ntype NegotiationMessage = z.infer<typeof NegotiationMessage>;\n\nfunction calcTrail(message: NegotiationMessage) {\n    let hash = message.trail;\n    for (const key of Object.keys(message).sort()) {\n        if (key == \"trail\" || key == \"signature\" || key == \"proposalSignature\") continue;\n        const value = message[key as keyof NegotiationMessage];\n        const valueHash = sha256(value?.toString() as any).toString();\n        hash = sha256(hash + valueHash).toString();\n    }\n    return hash;\n}\n\nconst NEGOTIATION_TIMEOUT = 10000;\nfunction validateMessage(message: string, expectedTrail: string, expectedProvider?: string): { message: NegotiationMessage | null, trail: string } {\n    let negotiationMessage: NegotiationMessage;\n    try {\n        negotiationMessage = NegotiationMessage.parse(JSON.parse(message));\n    } catch (error) {\n        return null;\n    }\n\n    if (negotiationMessage.timestamp && negotiationMessage.timestamp < new Date().getTime() - NEGOTIATION_TIMEOUT) {\n        return null;\n    }\n\n    if (negotiationMessage.trail !== expectedTrail) {\n        return null;\n    }\n\n    const trail = calcTrail(negotiationMessage);\n    const trailBytes = ethers.getBytes(\"0x\" + trail);\n\n    if (negotiationMessage.type == \"proposal\") {\n        if (!expectedProvider) {\n            return { message: null, trail };\n        }\n\n        const GIGACREW_PROPOSAL_PREFIX = new Uint8Array(32);\n        GIGACREW_PROPOSAL_PREFIX.set(ethers.toUtf8Bytes(\"GigaCrew Proposal: \"))\n        const abiCoder = new ethers.AbiCoder();\n        const proposalBytes = ethers.getBytes(abiCoder.encode(\n            [\"bytes32\", \"bytes32\", \"uint256\", \"uint256\", \"uint256\"],\n            [\n                ethers.hexlify(GIGACREW_PROPOSAL_PREFIX),\n                trailBytes,\n                negotiationMessage.proposalExpiry,\n                negotiationMessage.price,\n                negotiationMessage.deadline * 60\n            ]\n        ));\n        const extractedUser = ethers.recoverAddress(ethers.keccak256(proposalBytes), negotiationMessage.proposalSignature);\n        if (extractedUser != expectedProvider) {\n            return { message: null, trail };\n        }\n    }\n\n    return { message: negotiationMessage, trail };\n}\n\nexport { NegotiationMessage, calcTrail, validateMessage };\n"],"mappings":";AAAA,SAAS,SAAS;AAClB,OAAO,YAAY;AACnB,SAAS,cAAc;AAEvB,IAAM,qBAAqB,EAAE,OAAO;AAAA,EAChC,MAAM,EAAE,KAAK,CAAC,OAAO,UAAU,CAAC;AAAA,EAChC,SAAS,EAAE,OAAO;AAAA,EAClB,WAAW,EAAE,OAAO;AAAA,EACpB,OAAO,EAAE,OAAO;AAAA,EAEhB,OAAO,EAAE,OAAO,EAAE,MAAM,OAAO,EAAE,SAAS;AAAA,EAC1C,UAAU,EAAE,OAAO,EAAE,SAAS;AAAA,EAC9B,OAAO,EAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,gBAAgB,EAAE,OAAO,EAAE,SAAS;AAAA,EAEpC,mBAAmB,EAAE,OAAO,EAAE,SAAS;AAAA,EAEvC,KAAK,EAAE,OAAO,EAAE,SAAS;AAC7B,CAAC;AAGD,SAAS,UAAU,SAA6B;AAC5C,MAAI,OAAO,QAAQ;AACnB,aAAW,OAAO,OAAO,KAAK,OAAO,EAAE,KAAK,GAAG;AAC3C,QAAI,OAAO,WAAW,OAAO,eAAe,OAAO,oBAAqB;AACxE,UAAM,QAAQ,QAAQ,GAA+B;AACrD,UAAM,YAAY,OAAO,+BAAO,UAAiB,EAAE,SAAS;AAC5D,WAAO,OAAO,OAAO,SAAS,EAAE,SAAS;AAAA,EAC7C;AACA,SAAO;AACX;AAEA,IAAM,sBAAsB;AAC5B,SAAS,gBAAgB,SAAiB,eAAuB,kBAAkF;AAC/I,MAAI;AACJ,MAAI;AACA,yBAAqB,mBAAmB,MAAM,KAAK,MAAM,OAAO,CAAC;AAAA,EACrE,SAAS,OAAO;AACZ,WAAO;AAAA,EACX;AAEA,MAAI,mBAAmB,aAAa,mBAAmB,aAAY,oBAAI,KAAK,GAAE,QAAQ,IAAI,qBAAqB;AAC3G,WAAO;AAAA,EACX;AAEA,MAAI,mBAAmB,UAAU,eAAe;AAC5C,WAAO;AAAA,EACX;AAEA,QAAM,QAAQ,UAAU,kBAAkB;AAC1C,QAAM,aAAa,OAAO,SAAS,OAAO,KAAK;AAE/C,MAAI,mBAAmB,QAAQ,YAAY;AACvC,QAAI,CAAC,kBAAkB;AACnB,aAAO,EAAE,SAAS,MAAM,MAAM;AAAA,IAClC;AAEA,UAAM,2BAA2B,IAAI,WAAW,EAAE;AAClD,6BAAyB,IAAI,OAAO,YAAY,qBAAqB,CAAC;AACtE,UAAM,WAAW,IAAI,OAAO,SAAS;AACrC,UAAM,gBAAgB,OAAO,SAAS,SAAS;AAAA,MAC3C,CAAC,WAAW,WAAW,WAAW,WAAW,SAAS;AAAA,MACtD;AAAA,QACI,OAAO,QAAQ,wBAAwB;AAAA,QACvC;AAAA,QACA,mBAAmB;AAAA,QACnB,mBAAmB;AAAA,QACnB,mBAAmB,WAAW;AAAA,MAClC;AAAA,IACJ,CAAC;AACD,UAAM,gBAAgB,OAAO,eAAe,OAAO,UAAU,aAAa,GAAG,mBAAmB,iBAAiB;AACjH,QAAI,iBAAiB,kBAAkB;AACnC,aAAO,EAAE,SAAS,MAAM,MAAM;AAAA,IAClC;AAAA,EACJ;AAEA,SAAO,EAAE,SAAS,oBAAoB,MAAM;AAChD;","names":[]}